# Оглавление

- [Анализ установки Remnawave VPN: сравнение официального метода с автоматизированным скриптом eGames](#анализ-установки-remnawave-vpn-сравнение-официального-метода-с-автоматизированным-скриптом-egames)
  - [Обзор методов установки](#обзор-методов-установки)
  - [Плюсы и минусы скрипта eGames](#плюсы-и-минусы-скрипта-egames)
    - [Преимущества](#преимущества)
    - [Недостатки](#недостатки)
  - [Особенности и ограничения доступа к API](#особенности-и-ограничения-доступа-к-api)
    - [Локальный доступ к API](#локальный-доступ-к-api)
    - [Внешний доступ к API](#внешний-доступ-к-api)
  - [Доступ к Prometheus метрикам](#доступ-к-prometheus-метрикам)
    - [В оригинальной установке](#в-оригинальной-установке)
    - [В скрипте eGames](#в-скрипте-egames)
  - [Конфигурация переменных окружения](#конфигурация-переменных-окружения)
  - [Рекомендации по использованию скрипта eGames](#рекомендации-по-использованию-скрипта-egames)
  - [Рекомендации по безопасному изменению конфига XRAY](#рекомендации-по-безопасному-изменению-конфига-xray)
  - [Модификация конфигурации Nginx для внешнего доступа к API](#модификация-конфигурации-nginx-для-внешнего-доступа-к-api)
  - [Подключение продающего телеграм бота локально](#подключение-продающего-телеграм-бота-локально)

---

## Анализ установки Remnawave VPN: сравнение официального метода с автоматизированным скриптом eGames
...


### Обзор методов установки

**Официальная установка Remnawave** представляет собой стандартный подход, который включает четыре основных этапа: установку панели Remnawave, настройку обратного прокси, опциональную установку страницы подписок и установку узла Remnawave. Этот метод требует ручной настройки каждого компонента и предоставляет полный контроль над конфигурацией.

**Автоматизированный скрипт eGames** предназначен для упрощения развертывания reverse proxy сервера с использованием NGINX, а также автоматизации установки панели управления и узла Remnawave. Скрипт работает в конфигурации, где Xray функционирует напрямую на порту 443, передавая трафик через сокет, который прослушивает NGINX.

### Плюсы и минусы скрипта eGames

#### Преимущества:

1. **Полная автоматизация**: Скрипт автоматически настраивает все компоненты системы, включая NGINX, SSL-сертификаты, UFW и оптимизацию BBR.
2. **Повышенная безопасность**: Реализует защиту панели через cookie-авторизацию с использованием секретного ключа в URL-параметре. Доступ к панели возможен только через URL вида `https://panel.example.com/auth/login?<SECRET_KEY>=<SECRET_KEY>`.
3. **Автоустановка Subscription Page**: Устанавливается сразу с модифицированной страницей подписки.
4. **Автоматическая настройка доменов**: Поддерживает настройку через Cloudflare или ACME с автоматическим обновлением сертификатов.
5. **Оптимизированная производительность**: Минимизирует TCP overhead благодаря прямой работе Xray на порту 443.
6. **Поддержка различных архитектур**: Работает как на одном сервере (панель + узел), так и на разделенных серверах.
7. **Сертификат RU домена**: Поддерживает выдачу сертификатов для любых доменов, включая зону RU

#### Недостатки:

1. **Не предназначен для продакшна**: Автор явно указывает, что скрипт создан для образовательных целей и не рекомендуется для производственного использования.
2. **Ограниченный внешний доступ к API**: Cookie-защита блокирует прямой доступ к API панели извне без правильного cookie.
3. **Заблокированные Prometheus метрики**: Внешний доступ к метрикам на порту 3001 также защищен cookie-авторизацией.
4. **Зависимость от KVM виртуализации**: Скрипт тестировался только в среде KVM.

### Особенности и ограничения доступа к API

#### Локальный доступ к API:

В скрипте eGames панель Remnawave работает на порту 3000 локально. Для локального доступа к API можно использовать:

- **Прямое подключение**: `http://127.0.0.1:3000/api/`
- **SDK подключение**: Используя Remnawave SDK с базовым URL `http://127.0.0.1:3000`


#### Внешний доступ к API:

Скрипт eGames реализует систему защиты панели через cookie-авторизацию, что создает следующие ограничения:

1. **Требуется специальный cookie**: Для доступа к панели извне необходимо наличие cookie с именем `<SECRET_KEY>` и значением `<SECRET_KEY>`.
2. **URL-параметр для первичного доступа**: Первый доступ должен осуществляться через URL с секретным параметром, который устанавливает необходимый cookie.
3. **Блокировка прямого API доступа**: Без правильного cookie все запросы к API будут возвращать пустую страницу или ошибку 404.

### Доступ к Prometheus метрикам

#### В оригинальной установке:

<details>
  <summary>Prometheus метрики доступны на порту 3001 с базовой HTTP-аутентификацией:</summary>

```yaml
scrape_configs:
  - job_name: 'remnawave'
    scheme: http
    metrics_path: /metrics
    static_configs:
      - targets: ['remnawave:3001']
    basic_auth:
      username: admin
      password: change_me
```
</details>


#### В скрипте eGames:

Доступ к Prometheus метрикам также защищен cookie-системой, что означает:

- **Локальный доступ**: Возможен напрямую через `http://127.0.0.1:3001/metrics`
- **Внешний доступ**: Заблокирован без правильного cookie-набора


### Конфигурация переменных окружения

<details>
  <summary>Основные переменные среды для внешнего подключения:</summary>

| Переменная | Назначение | Значение по умолчанию |
| :-- | :-- | :-- |
| `APP_PORT` | Порт панели | 3000 |
| `METRICS_PORT` | Порт метрик | 3001 |
| `METRICS_USER` | Пользователь метрик | admin |
| `METRICS_PASS` | Пароль метрик | change_me |
| `JWT_AUTH_SECRET` | Секрет JWT авторизации | change_me |
| `JWT_API_TOKENS_SECRET` | Секрет API токенов | change_me |

</details>

---

### Рекомендации по использованию скрипта eGames

**Для обучения, частного использования**: Скрипт eGames отлично подходит благодаря полной автоматизации и встроенным мерам безопасности.

**Для продакшна**: Рекомендуется использовать официальный метод установки с разделением панели и ноды по разным серверам с ручной настройкой всех компонентов для обеспечения полного контроля над конфигурацией и безопасностью. 

*Использование скрипта eGames в продакшне возможно при должном уровне технической подготовки специалиста: для связи с продающим сервисом, отдачи метрик, обеспечения доступа к API. **Помните: официальное сообщество Remnawave не сможет помочь в решениях проблем, которые могут возникать при установке по скрипту eGames.** Продакшн по скрипту eGames - только для специалистов, полностью понимающих всю суть конфигурации и способных ее обслуживать и модифицировать под свою задачу.*

**Для внешнего API доступа**: Если требуется программный доступ к API Remnawave извне, необходимо либо модифицировать конфигурацию NGINX в скрипте eGames, либо использовать официальный метод установки.

**Для мониторинга**: При необходимости внешнего доступа к Prometheus метрикам следует предпочесть официальную установку или настроить дополнительные эндпоинты в NGINX конфигурации скрипта eGames.

---

### Рекомендации по безопасному изменению конфига XRAY:

**Актуально для установки Панель + Нода**

1. Запустите скрипт eGames на сервере командой `remnawave_reverse`

2.  Выбрав пункт **Управление доступом к панели (Только для панели + нода)**, включите доступ к панели на 8443 порту

3.  Перейдите в панель по ссылке, выданной скриптом. Доступ должен быть на 8443 порту.

4.  В панели Remnawave смело настраивайте конфиг XRAY. При этом даже если конфигурация окажется нерабочей и "уронит" за собой ноду, у вас останется доступ к панели и вы сможете откатить изменения (вы ведь на всякий случай скопировали в блокнотик свой конфиг перед правками, правда?)

5.  После завершения настроек вернитесь в скрипт `remnawave_reverse` и отключите доступ к панели на 8443 порту

6.  Вы молодец!


---


### Модификация конфигурации Nginx для внешнего доступа к API

 **(установка панель + нода)**


<details>
  <summary>Конфигурация Nginx</summary>

  Добавляем в `nginx.conf` в блок сервера с доменом панели `server_name panel.domen.com;`

  здесь вместо `allow 192.168.1.100;` вписываем свой IP адрес сервера, с которого будем коннектится на API Remnawave

  ```
location ^~ /api/ {
    allow 192.168.1.100;
    deny all; 
    proxy_http_version 1.1;
    proxy_pass http://remnawave;
    proxy_set_header Host $host;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}
  ```

  Это открывает доступ к API из-вне, при этом API будут по прежнему защищены токеном авторизации

</details>

---

### Подключение продающего телеграм бота локально

При установке по скрипту eGames можно подключить продающего телеграм-бота, установив его на тот же сервер, что и панель с нодой, правильно подключив его к сети Remnawave в `docker-compose.yml` конфиге:

```
networks:
  remnawave-network:
    name: remnawave-network
    driver: bridge
    external: true
```

<details>
  <summary>Пример конфига `docker-compose.yml` продающего бота</summary>

  ```
  services:
  bot:
    #    build: .
    image: ghcr.io/jolymmiels/remnawave-telegram-shop-bot:latest
    restart: always
    env_file:
      - .env
    environment:
      - TZ=Europe/Moscow
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./translations:/translations
    networks:
      - remnawave-network
  db:
    image: postgres:17
    container_name: remnawave-telegram-shop-db
    hostname: remnawave-telegram-shop-db
    restart: always
    env_file:
      - .env
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - TZ=UTC
    ports:
      - 127.0.0.1:5432:5432
    volumes:
      - remnawave-telegram-shop-db-data:/var/lib/postgresql/data
    healthcheck:
      test:
        - CMD-SHELL
        - pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}
      interval: 3s
      timeout: 10s
      retries: 3
    networks:
      - remnawave-network
volumes:
  remnawave-telegram-shop-db-data:
    driver: local
    external: false
    name: remnawave-telegram-shop-db-data
networks:
  remnawave-network:
    name: remnawave-network
    driver: bridge
    external: true
  ```

  </details>


---

1.: https://remna.st/docs/overview/quick-start

2.: https://github.com/eGames/remnawave-reverse-proxy

3.: https://github.com/sm1ky/remnawave-api

4.: https://prometheus.io/docs

5.: https://remna.st/docs/install/remnawave-subscription-page
